<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Drafteo Online de Pokémon UNITE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE (INTEGRADA) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBVBM0lEVF7oJwaIUYoEY2vc5eLXMPkw3I",
          authDomain: "simulador-unite.firebaseapp.com",
          projectId: "simulador-unite",
          storageBucket: "simulador-unite.firebasestorage.app",
          messagingSenderId: "562805600014",
          appId: "1:562805600014:web:ae9ad79882a5afb477b15f",
          measurementId: "G-YMCV11HQH0"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.app = { db, auth, doc, onSnapshot, setDoc, getDoc, updateDoc, signInAnonymously, onAuthStateChanged, serverTimestamp, deleteDoc };
    </script>
    <style>
        @keyframes aurora { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        body { font-family: 'Exo 2', sans-serif; background-color: #0C0C1E; color: #e0e0e0; position: relative; }
        body::before {
            content: ''; position: fixed; width: 150vmax; height: 150vmax; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, #3b82f6 0%, transparent 30%), radial-gradient(circle, #ec4899 0%, transparent 30%), radial-gradient(circle, #8b5cf6 0%, transparent 30%);
            background-blend-mode: screen; filter: blur(100px); opacity: 0.3; animation: aurora 25s linear infinite; z-index: -1;
        }
        .modern-panel { background: rgba(12, 12, 30, 0.5); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid #22253b; border-radius: 1.5rem; }
        .pokemon-card { transition: all 0.2s ease-in-out; cursor: pointer; border: 2px solid transparent; border-radius: 1rem; }
        .pokemon-card.selected { transform: translateY(-4px); border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.7); }
        .pokemon-card.disabled { filter: grayscale(100%) opacity(0.4); pointer-events: none; }
        .bg-role-Attacker { background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-Defender { background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-Speedster { background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-All-Rounder { background: radial-gradient(circle at top right, rgba(168, 85, 247, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-Supporter { background: radial-gradient(circle at top right, rgba(234, 179, 8, 0.5), rgba(22, 25, 59, 0.5)); }
        .main-title { background: linear-gradient(90deg, #67e8f9, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .styled-button { background-image: linear-gradient(to right, #0ea5e9 0%, #a855f7 50%, #d946ef 100%); background-size: 200% auto; transition: all 0.3s; }
        .styled-button:hover:not(:disabled) { background-position: right center; }
        .styled-button:disabled { background-image: none; background-color: #374151; cursor: not-allowed; }
        .secondary-button { background-color: rgba(30, 41, 59, 0.5); border: 1px solid #334155; transition: all 0.2s; }
        .secondary-button:hover { background-color: rgba(51, 65, 85, 0.7); border-color: #475569; }
        .team-slot.picking { transform: scale(1.03); box-shadow: 0 0 20px, 0 0 10px inset; border-color: #facc15; }
        .modal-content-area { background: rgba(12, 12, 30, 0.8); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid #38bdf8; border-radius: 1.5rem; }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div id="draft-simulator" class="main-content w-full max-w-screen-xl mx-auto flex flex-col h-screen">
        
        <header class="text-center mb-4 shrink-0">
            <h1 class="text-4xl sm:text-5xl font-extrabold main-title">SIMULADOR DE DRAFTEO ONLINE</h1>
            <p class="text-slate-300 font-semibold">Creado por: <span class="font-bold text-cyan-400">antuan</span></p>
        </header>

        <div id="lobby-screen" class="flex-grow flex flex-col justify-center items-center gap-6">
            <div class="modern-panel p-8 rounded-2xl text-center w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Ingresa tu nombre de usuario</h2>
                <input type="text" id="username-input" class="w-full bg-slate-800 text-white p-3 rounded-lg text-center" placeholder="Tu nombre...">
            </div>
            <div id="lobby-buttons" class="flex flex-col sm:flex-row gap-4">
                 <button id="create-game-button" class="styled-button text-white font-bold py-4 px-8 rounded-2xl text-xl">Crear Partida</button>
                 <button id="join-game-button" class="secondary-button text-white font-bold py-4 px-8 rounded-2xl text-xl">Unirse a Partida</button>
            </div>
            <div id="team-selection" class="hidden flex-col items-center gap-4">
                <h3 class="text-xl font-bold">Elige tu equipo</h3>
                <div class="flex gap-4">
                    <button id="choose-purple" class="secondary-button text-purple-400 font-bold py-3 px-6 rounded-xl">Equipo Morado</button>
                    <button id="choose-orange" class="secondary-button text-orange-400 font-bold py-3 px-6 rounded-xl">Equipo Naranja</button>
                </div>
            </div>
             <div id="waiting-room" class="hidden text-center modern-panel p-6">
                <p>Esperando oponente... Comparte este código:</p>
                <p id="game-code-display" class="text-2xl font-bold text-yellow-300 mt-2 cursor-pointer" title="Copiar código"></p>
            </div>
        </div>
        
        <div id="draft-container" class="hidden flex-grow flex-col min-h-0">
            <!-- El contenido del draft se generará aquí -->
        </div>
    </div>
    
    <template id="draft-template">
        <!-- ... (estructura del draft UI) ... -->
    </template>
    
    <script type="module">
        const { db, auth, doc, onSnapshot, setDoc, getDoc, updateDoc, signInAnonymously, onAuthStateChanged, serverTimestamp, deleteDoc } = window.app;

        let localPlayer = {};
        let currentUnsubscribe;

        const dom = {
            lobbyScreen: document.getElementById('lobby-screen'),
            draftContainer: document.getElementById('draft-container'),
            createGameButton: document.getElementById('create-game-button'),
            joinGameButton: document.getElementById('join-game-button'),
            usernameInput: document.getElementById('username-input'),
            teamSelection: document.getElementById('team-selection'),
            choosePurple: document.getElementById('choose-purple'),
            chooseOrange: document.getElementById('choose-orange'),
            waitingRoom: document.getElementById('waiting-room'),
            gameCodeDisplay: document.getElementById('game-code-display'),
            lobbyButtons: document.getElementById('lobby-buttons'),
        };

        const initialGameState = { phase: 'WAITING', turn: 'PURPLE', purpleBans: [], orangeBans: [], purplePicks: [], orangePicks: [], pickOrderIndex: 0, banOrderIndex: 0, selectedPokemon: {}, players: {} };
       
        function showTeamSelection() {
            const username = dom.usernameInput.value.trim();
            if (!username) { alert("Por favor, ingresa un nombre de usuario."); return; }
            dom.lobbyButtons.classList.add('hidden');
            dom.teamSelection.classList.remove('hidden');
            dom.teamSelection.classList.add('flex');
        }

        async function createGame(chosenTeam) {
            const username = dom.usernameInput.value.trim();
            await (auth.currentUser ? Promise.resolve() : signInAnonymously(auth));
            
            const gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const gameRef = doc(db, "games", gameId);
            
            localPlayer = { id: auth.currentUser.uid, name: username, team: chosenTeam };
            const initialData = { ...initialGameState, players: { [localPlayer.id]: localPlayer }, gameId };
            
            await setDoc(gameRef, initialData);

            dom.teamSelection.classList.add('hidden');
            dom.waitingRoom.classList.remove('hidden');
            dom.gameCodeDisplay.textContent = gameId;

            startGame(gameId, localPlayer);
        }

        async function joinGame() {
            const username = dom.usernameInput.value.trim();
            if (!username) { alert("Por favor, ingresa un nombre de usuario."); return; }
            
            const gameId = prompt("Ingresa el ID de la partida:");
            if (!gameId) return;

            await (auth.currentUser ? Promise.resolve() : signInAnonymously(auth));
            const userId = auth.currentUser.uid;
            
            const gameRef = doc(db, "games", gameId);
            const gameDoc = await getDoc(gameRef);

            if (!gameDoc.exists()) { alert("Partida no encontrada."); return; }

            const gameData = gameDoc.data();
            if (Object.keys(gameData.players).length >= 2) { alert("La sala está llena."); return; }
            
            const creator = Object.values(gameData.players)[0];
            const joinerTeam = creator.team === 'PURPLE' ? 'ORANGE' : 'PURPLE';
            localPlayer = { id: userId, name: username, team: joinerTeam };
            
            await updateDoc(gameRef, {
                [`players.${userId}`]: localPlayer,
                phase: 'BAN',
                timerStart: serverTimestamp()
            });
            startGame(gameId, localPlayer);
        }

        function startGame(gameId, playerInfo) {
            localPlayer = playerInfo;
            dom.lobbyScreen.classList.add('hidden');
            // ... (Lógica para renderizar la UI del draft) ...
            dom.draftContainer.classList.remove('hidden');

            if(currentUnsubscribe) currentUnsubscribe();
            currentUnsubscribe = onSnapshot(doc(db, "games", gameId), (doc) => {
                if(doc.exists()){
                    const gameState = doc.data();
                    if(gameState.phase === 'WAITING' && Object.keys(gameState.players).length === 1) {
                         // Still waiting, do nothing for the creator
                    } else {
                         // Game has started or opponent joined
                         // updateUI(gameState);
                    }
                } else {
                    alert("La partida ha terminado o fue cancelada.");
                    initializeLobby();
                }
            });
        }
        
        function initializeLobby() {
            if (currentUnsubscribe) currentUnsubscribe();
            dom.lobbyScreen.classList.remove('hidden');
            dom.draftContainer.classList.add('hidden');
            dom.lobbyButtons.classList.remove('hidden');
            dom.teamSelection.classList.add('hidden');
            dom.waitingRoom.classList.add('hidden');
        }

        dom.createGameButton.addEventListener('click', showTeamSelection);
        dom.joinGameButton.addEventListener('click', joinGame);
        dom.choosePurple.addEventListener('click', () => createGame('PURPLE'));
        dom.chooseOrange.addEventListener('click', () => createGame('ORANGE'));
        dom.gameCodeDisplay.addEventListener('click', () => {
            navigator.clipboard.writeText(dom.gameCodeDisplay.textContent).then(() => alert('Código copiado al portapapeles.'));
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Authenticated anonymously:", user.uid);
            }
        });

        initializeLobby();
    </script>
</body>
</html>
