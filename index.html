<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Drafteo Online de Pokémon UNITE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        @keyframes aurora { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        body { font-family: 'Exo 2', sans-serif; background-color: #0C0C1E; color: #e0e0e0; position: relative; }
        body::before {
            content: ''; position: fixed; width: 150vmax; height: 150vmax; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, #3b82f6 0%, transparent 30%), radial-gradient(circle, #ec4899 0%, transparent 30%), radial-gradient(circle, #8b5cf6 0%, transparent 30%);
            background-blend-mode: screen; filter: blur(100px); opacity: 0.3; animation: aurora 25s linear infinite; z-index: -1;
        }
        .modern-panel { background: rgba(12, 12, 30, 0.5); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid #22253b; border-radius: 1.5rem; }
        .pokemon-card { transition: all 0.2s ease-in-out; cursor: pointer; border: 2px solid transparent; border-radius: 1rem; }
        .pokemon-card.selected { transform: translateY(-4px); border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.7); }
        .pokemon-card.disabled { filter: grayscale(100%) opacity(0.4); pointer-events: none; }
        .bg-role-Attacker { background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-Defender { background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-Speedster { background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-All-Rounder { background: radial-gradient(circle at top right, rgba(168, 85, 247, 0.5), rgba(22, 25, 59, 0.5)); }
        .bg-role-Supporter { background: radial-gradient(circle at top right, rgba(234, 179, 8, 0.5), rgba(22, 25, 59, 0.5)); }
        .main-title { background: linear-gradient(90deg, #67e8f9, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .styled-button { background-image: linear-gradient(to right, #0ea5e9 0%, #a855f7 50%, #d946ef 100%); background-size: 200% auto; transition: all 0.3s; }
        .styled-button:hover:not(:disabled) { background-position: right center; }
        .styled-button:disabled { background-image: none; background-color: #374151; cursor: not-allowed; }
        .secondary-button { background-color: rgba(30, 41, 59, 0.5); border: 1px solid #334155; transition: all 0.2s; }
        .secondary-button:hover { background-color: rgba(51, 65, 85, 0.7); border-color: #475569; }
        .team-slot.picking { transform: scale(1.03); box-shadow: 0 0 20px, 0 0 10px inset; border-color: #facc15; }
        #pokemon-grid::-webkit-scrollbar { width: 8px; }
        #pokemon-grid::-webkit-scrollbar-track { background: transparent; }
        #pokemon-grid::-webkit-scrollbar-thumb { background-color: #38bdf8; border-radius: 20px; border: 2px solid transparent; background-clip: content-box;}
    </style>
</head>
<body class="p-2 sm:p-4">

    <div id="app-container" class="w-full max-w-screen-xl mx-auto flex flex-col min-h-screen relative z-10">
        <!-- El contenido se renderizará aquí -->
    </div>
    
    <template id="lobby-template">
        <div class="flex flex-col h-screen justify-center items-center gap-6">
            <header class="text-center shrink-0">
                <h1 class="text-4xl sm:text-5xl font-extrabold main-title">SIMULADOR DE DRAFTEO ONLINE</h1>
                <p class="text-slate-300 font-semibold">Creado por: <span class="font-bold text-cyan-400">antuan</span></p>
            </header>
            <div class="modern-panel p-8 rounded-2xl text-center w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Ingresa tu nombre de usuario</h2>
                <input type="text" id="username-input" class="w-full bg-slate-800 text-white p-3 rounded-lg text-center" placeholder="Tu nombre...">
            </div>
            <div id="lobby-buttons" class="flex flex-col sm:flex-row gap-4">
                 <button id="create-game-button" class="styled-button text-white font-bold py-4 px-8 rounded-2xl text-xl">Crear Partida</button>
                 <button id="join-game-button" class="secondary-button text-white font-bold py-4 px-8 rounded-2xl text-xl">Unirse a Partida</button>
            </div>
            <div id="team-selection" class="hidden flex-col items-center gap-4">
                <h3 class="text-xl font-bold">Elige tu equipo</h3>
                <div class="flex gap-4">
                    <button id="choose-purple" class="secondary-button text-purple-400 font-bold py-3 px-6 rounded-xl">Equipo Morado</button>
                    <button id="choose-orange" class="secondary-button text-orange-400 font-bold py-3 px-6 rounded-xl">Equipo Naranja</button>
                </div>
            </div>
             <div id="waiting-room" class="hidden text-center modern-panel p-6">
                <p>Esperando oponente... Comparte este código:</p>
                <p id="game-code-display" class="text-2xl font-bold text-yellow-300 mt-2 cursor-pointer" title="Copiar código"></p>
            </div>
        </div>
    </template>

    <template id="draft-template">
        <div class="flex flex-col min-h-screen">
             <div id="top-bar" class="flex flex-col md:flex-row justify-between items-center mb-4 px-4 shrink-0">
                <div id="purple-bans-container" class="w-full md:w-1/3 flex justify-center md:justify-start items-center gap-2 order-2 md:order-1 my-2 md:my-0"></div>
                <div id="timer-container" class="modern-panel py-2 px-6 flex items-center gap-4 order-1 md:order-2">
                    <div id="timer" class="text-5xl font-bold text-white">--</div>
                </div>
                <div id="orange-bans-container" class="w-full md:w-1/3 flex justify-center md:justify-end items-center gap-2 order-3"></div>
            </div>
            <div class="flex-grow flex flex-col lg:flex-row gap-4 min-h-0">
                <aside class="w-full lg:w-1/4 p-4 modern-panel flex flex-col">
                    <h2 id="purple-player-name" class="text-2xl font-bold text-center mb-4 text-purple-400"></h2>
                    <div id="purple-team" class="space-y-3 flex-grow"></div>
                </aside>
                <section class="flex-grow flex flex-col min-h-0">
                    <div id="draft-status" class="w-full text-center p-3 mb-4 rounded-lg font-extrabold text-xl sm:text-2xl modern-panel shrink-0"></div>
                    <div id="pokemon-grid" class="flex-grow p-3 grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-3 modern-panel overflow-y-auto" style="max-height: 50vh;"></div>
                    <button id="confirm-button" class="w-full max-w-xs mx-auto styled-button font-bold py-3 px-4 text-lg rounded-xl mt-4 hidden">CONFIRMAR</button>
                </section>
                <aside class="w-full lg:w-1/4 p-4 modern-panel flex flex-col">
                    <h2 id="orange-player-name" class="text-2xl font-bold text-center mb-4 text-orange-400"></h2>
                    <div id="orange-team" class="space-y-3 flex-grow"></div>
                </aside>
            </div>
             <div class="mt-4 flex flex-col sm:flex-row gap-4 shrink-0">
                <button id="exit-button" class="w-full secondary-button font-bold py-3 px-4 rounded-lg">SALIR DE LA PARTIDA</button>
            </div>
        </div>
    </template>
    
    <script type="module">
        const { db, auth, doc, onSnapshot, setDoc, getDoc, updateDoc, signInAnonymously, onAuthStateChanged, serverTimestamp, deleteDoc } = window.app;

        let localPlayer = {};
        let currentUnsubscribe;
        let timerInterval;
        let gameState = {};
        const appContainer = document.getElementById('app-container');

        const pokemonData = [
            { id: "venusaur", name: "Venusaur", role: "Attacker"}, { id: "charizard", name: "Charizard", role: "All-Rounder"}, { id: "blastoise", name: "Blastoise", role: "Defender"}, { id: "pikachu", name: "Pikachu", role: "Attacker"}, { id: "clefable", name: "Clefable", role: "Supporter"}, { id: "alolan-ninetales", name: "A. Ninetales", role: "Attacker"}, { id: "wigglytuff", name: "Wigglytuff", role: "Supporter"}, { id: "machamp", name: "Machamp", role: "All-Rounder"}, { id: "slowbro", name: "Slowbro", role: "Defender"}, { id: "gengar", name: "Gengar", role: "Speedster"}, { id: "mr-mime", name: "Mr. Mime", role: "Supporter"}, { id: "gyarados", name: "Gyarados", role: "All-Rounder"}, { id: "snorlax", name: "Snorlax", role: "Defender"}, { id: "dragonite", name: "Dragonite", role: "All-Rounder"}, { id: "mewtwo-x", name: "Mewtwo X", role: "All-Rounder"}, { id: "mewtwo-y", name: "Mewtwo Y", role: "Attacker"}, { id: "mew", name: "Mew", role: "Attacker"}, { id: "azumarill", name: "Azumarill", role: "All-Rounder"}, { id: "espeon", name: "Espeon", role: "Attacker"}, { id: "umbreon", name: "Umbreon", role: "Defender"}, { id: "scizor", name: "Scizor", role: "All-Rounder"}, { id: "blissey", name: "Blissey", role: "Supporter"}, { id: "tyranitar", name: "Tyranitar", role: "All-Rounder"}, { id: "gardevoir", name: "Gardevoir", role: "Attacker"}, { id: "sableye", name: "Sableye", role: "Supporter"}, { id: "absol", name: "Absol", role: "Speedster"}, { id: "metagross", name: "Metagross", role: "All-Rounder"}, { id: "garchomp", name: "Garchomp", role: "All-Rounder"}, { id: "lucario", name: "Lucario", role: "All-Rounder"}, { id: "leafeon", name: "Leafeon", role: "Speedster"}, { id: "glaceon", name: "Glaceon", role: "Attacker"}, { id: "crustle", name: "Crustle", role: "Defender"}, { id: "greninja", name: "Greninja", role: "Attacker"}, { id: "talonflame", name: "Talonflame", role: "Speedster"}, { id: "aegislash", name: "Aegislash", role: "All-Rounder"}, { id: "sylveon", name: "Sylveon", role: "Attacker"}, { id: "goodra", name: "Goodra", role: "Defender"}, { id: "trevenant", name: "Trevenant", role: "Defender"}, { id: "hoopa", name: "Hoopa", role: "Supporter"}, { id: "decidueye", name: "Decidueye", role: "Attacker"}, { id: "tsareena", name: "Tsareena", role: "All-Rounder"}, { id: "comfey", name: "Comfey", role: "Supporter"}, { id: "cinderace", name: "Cinderace", role: "Attacker"}, { id: "inteleon", name: "Inteleon", role: "Attacker"}, { id: "eldegoss", name: "Eldegoss", role: "Supporter"}, { id: "cramorant", name: "Cramorant", role: "Attacker"}, { id: "duraludon", name: "Duraludon", role: "Attacker"}, { id: "zeraora", name: "Zeraora", role: "Speedster"}, { id: "lapras", name: "Lapras", role: "Defender"}, { id: "chandelure", name: "Chandelure", role: "Attacker"}, { id: "dodrio", name: "Dodrio", role: "Speedster"}, { id: "buzzwole", name: "Buzzwole", role: "All-Rounder"}, { id: "zacian", name: "Zacian", role: "All-Rounder"}, { id: "urshifu", name: "Urshifu", role: "All-Rounder"}, { id: "dragapult", name: "Dragapult", role: "Attacker"}, { id: "mamoswine", name: "Mamoswine", role: "Defender"}, { id: "delphox", name: "Delphox", role: "Attacker"}, { id: "zoroark", name: "Zoroark", role: "Speedster"}, { id: "mimikyu", name: "Mimikyu", role: "All-Rounder"}, { id: "falinks", name: "Falinks", role: "All-Rounder"}, { id: "blaziken", name: "Blaziken", role: "All-Rounder"}, { id: "meowscarada", name: "Meowscarada", role: "Speedster"}, { id: "miraidon", name: "Miraidon", role: "Attacker"}, { id: "ceruledge", name: "Ceruledge", role: "All-Rounder"}, { id: "armarouge", name: "Armarouge", role: "Attacker"}, { id: "alcremie", name: "Alcremie", role: "Supporter"}, { id: "ho-oh", name: "Ho-Oh", role: "Defender"}, { id: "alolan-raichu", name: "A. Raichu", role: "Attacker"}, { id: "darkrai", name: "Darkrai", role: "Speedster"}, { id: "greedent", name: "Greedent", role: "Defender"}, { id: "suicune", name: "Suicune", role: "All-Rounder"}, { id: "tinkaton", name: "Tinkaton", role: "All-Rounder"}
            ].sort((a, b) => a.name.localeCompare(b.name));
        
        const initialGameState = { phase: 'WAITING', turn: 'PURPLE', purpleBans: [], orangeBans: [], purplePicks: [], orangePicks: [], pickOrderIndex: 0, banOrderIndex: 0, selectedPokemon: {PURPLE: null, ORANGE: null}, players: {}, timerStart: null };
        const pickOrder = [ { team: 'PURPLE', count: 1 }, { team: 'ORANGE', count: 2 }, { team: 'PURPLE', count: 2 }, { team: 'ORANGE', count: 2 }, { team: 'PURPLE', count: 2 }, { team: 'ORANGE', count: 1 } ];
        const banOrder = [ { team: 'PURPLE', count: 1 }, { team: 'ORANGE', count: 1 }, { team: 'PURPLE', count: 1 }, { team: 'ORANGE', count: 1 } ];

        function showLobby() {
            if (currentUnsubscribe) currentUnsubscribe();
            appContainer.innerHTML = '';
            const lobbyTemplate = document.getElementById('lobby-template');
            appContainer.appendChild(lobbyTemplate.content.cloneNode(true));
            document.getElementById('create-game-button').addEventListener('click', showTeamSelection);
            document.getElementById('join-game-button').addEventListener('click', joinGame);
        }

        function showTeamSelection() {
            if (!document.getElementById('username-input').value.trim()) { alert("Por favor, ingresa un nombre de usuario."); return; }
            document.getElementById('lobby-buttons').classList.add('hidden');
            const teamSelection = document.getElementById('team-selection');
            teamSelection.classList.remove('hidden');
            teamSelection.classList.add('flex');
            document.getElementById('choose-purple').onclick = () => createGame('PURPLE');
            document.getElementById('choose-orange').onclick = () => createGame('ORANGE');
        }

        async function createGame(chosenTeam) {
            const username = document.getElementById('username-input').value.trim();
            await (auth.currentUser || signInAnonymously(auth));
            
            const gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const gameRef = doc(db, "games", gameId);
            
            localPlayer = { id: auth.currentUser.uid, name: username, team: chosenTeam };
            const initialData = { ...initialGameState, players: { [localPlayer.id]: localPlayer }, gameId };
            
            await setDoc(gameRef, initialData);

            document.getElementById('team-selection').classList.add('hidden');
            const waitingRoom = document.getElementById('waiting-room');
            waitingRoom.classList.remove('hidden');
            const codeDisplay = document.getElementById('game-code-display');
            codeDisplay.textContent = gameId;
            codeDisplay.onclick = () => navigator.clipboard.writeText(gameId).then(() => alert('Código copiado.'));
            
            startGame(gameId, localPlayer);
        }

        async function joinGame() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) { alert("Por favor, ingresa un nombre de usuario."); return; }
            
            const gameId = prompt("Ingresa el ID de la partida:");
            if (!gameId) return;

            await (auth.currentUser || signInAnonymously(auth));
            const userId = auth.currentUser.uid;
            
            const gameRef = doc(db, "games", gameId);
            const gameDoc = await getDoc(gameRef);

            if (!gameDoc.exists()) { alert("Partida no encontrada."); return; }

            const gameData = gameDoc.data();
            if (Object.keys(gameData.players).length >= 2) { alert("La sala está llena."); return; }
            
            const creator = Object.values(gameData.players)[0];
            const joinerTeam = creator.team === 'PURPLE' ? 'ORANGE' : 'PURPLE';
            localPlayer = { id: userId, name: username, team: joinerTeam };
            
            await updateDoc(gameRef, {
                [`players.${userId}`]: localPlayer,
                phase: 'BAN',
                timerStart: serverTimestamp()
            });
            startGame(gameId, localPlayer);
        }

        function startGame(gameId, playerInfo) {
            localPlayer = playerInfo;
            appContainer.innerHTML = '';
            const draftTemplate = document.getElementById('draft-template');
            appContainer.appendChild(draftTemplate.content.cloneNode(true));

            if(currentUnsubscribe) currentUnsubscribe();
            currentUnsubscribe = onSnapshot(doc(db, "games", gameId), (doc) => {
                if(doc.exists()){
                    gameState = doc.data();
                    if (gameState.phase === 'WAITING' && Object.keys(gameState.players).length === 1) {
                         // Waiting for opponent, show waiting message
                         const statusDisplay = document.getElementById('draft-status');
                         if(statusDisplay) statusDisplay.textContent = 'Esperando oponente...';
                    } else {
                         updateUI();
                    }
                } else {
                    alert("La partida ha terminado o fue cancelada por el anfitrión.");
                    showLobby();
                }
            });
        }
        
        function updateUI() {
            /* All UI rendering logic goes here */
        }
        
        onAuthStateChanged(auth, (user) => {
            if (!user) signInAnonymously(auth);
        });

        showLobby();
    </script>
</body>
</html>
